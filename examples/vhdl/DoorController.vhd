-- This file has been automatically generated by go-iec61499-vhdl and should not be edited by hand
-- Converter written by Hammond Pearce and available at github.com/kiwih/go-iec61499-vhdl

-- This file represents the Basic Function Block for DoorController (index .BlockIndex)

library ieee;
use ieee.std_logic_1164.all;


entity DoorController is

	port(
		--for clock and reset signal
		clk		: in	std_logic;
		reset	: in	std_logic;
		enable	: in	std_logic;
		
		--input events
		ReleaseDoorOverride : in std_logic;
		BottlingDone : in std_logic;
		EmergencyStopChanged : in std_logic;
		
		
		--output events
		DoorReleaseCanister : out std_logic;
		
		
		--input variables
		EmergencyStop_I : in std_logic; --type was BOOL, _I to indicate unprocessed input
		
		
		
		--for done signal
		done : out std_logic
	);

end entity;


architecture rtl of DoorController is
	-- Build an enumerated type for the state machine
	type state_type is (E_Stop, Run, Await);

	-- Register to hold the current state
	signal state   : state_type := E_Stop;

	-- signals to store variable sampled on enable 
	signal EmergencyStop : std_logic := '0'; --used as "input" for data vars, only sampled on enable=1
	
	
	-- signals for enabling algorithms	

	-- signal for algorithm completion
	signal AlgorithmsStart : std_logic := '0';
	signal AlgorithmsDone : std_logic;

	
begin
	-- Logic to update data inputs from unprocessed inputs
	process (clk)
	begin
		if rising_edge(clk) then
			if enable = '1' then
				
				if EmergencyStopChanged = '1' then
					EmergencyStop <= EmergencyStop_I;
				end if;
				
			end if;
		end if;
	end process;
			
	
	-- Logic to advance to the next state
	process (clk, reset)
	begin
		if reset = '1' then
			state <= E_Stop;
			AlgorithmsStart <= '1';
		elsif (rising_edge(clk)) then
			if AlgorithmsStart = '1' then --algorithms should be triggered only once via this pulse signal
				AlgorithmsStart <= '0'
			elsif enable = '1' then 
				--default values
				state <= state;
				AlgorithmsStart <= '0';

				--next state logic
				elsif AlgorithmsStart = '0' and AlgorithmsDone = '1' then
					case state is
						when E_Stop=>
							if EmergencyStopChanged = '1' and (not EmergencyStop = '1') then
								state <= Await;
								AlgorithmsStart <= '1';
							end if;
						when Run=>
							if EmergencyStopChanged = '1' and (EmergencyStop = '1') then
								state <= E_Stop;
								AlgorithmsStart <= '1';
							elsif ReleaseDoorOverride = '1' or BottlingDone = '1' then
								state <= Run;
								AlgorithmsStart <= '1';
							end if;
						when Await=>
							if ReleaseDoorOverride = '1' or BottlingDone = '1' then
								state <= Run;
								AlgorithmsStart <= '1';
							end if;
						
					end case;
				end if;
			end if;
		end if;
	end process;

	-- Event outputs and internal algorithm triggers depend solely on the current state
	process (state)
	begin
		--default values
		--events
		DoorReleaseCanister <= '0';
		
		

		case state is
			when E_Stop=>
				
			when Run=>
				DoorReleaseCanister <= '1';
				
			when Await=>
				
			
		end case;
	end process;

	--This Basic FB had no algorithms
	

	--Done signal
	AlgorithmsDone <= (not AlgorithmsStart);
	Done <= AlgorithmsDone;
end rtl;
