// This file is generated by FBC.

#include "IOManager.h"
#include <string.h>
#include <stdio.h>

/* Function block initialization function */
void IOManagerinit(IOManager* me)
{
    me->_entered = false;

    me->_input.event.DoorReleaseCanister = 0;
    me->_input.event.ConveyorChanged = 0;
    me->_input.event.InjectorPositionChanged = 0;
    me->_input.event.InjectorControlsChanged = 0;
    me->_input.event.FillContentsChanged = 0;
    me->_input.event.StartVacuumTimer = 0;
    me->_input.event.GoRejectArm = 0;
    me->_input.event.CanisterCountChanged = 0;
	me->_input.event.InjectDone = 0;

    me->_output.event.InjectorArmFinishMovement = 0;
    me->_output.event.EmergencyStopChanged = 0;
    me->_output.event.CanisterPressureChanged = 0;
    me->_output.event.FillContentsAvailableChanged = 0;
    me->_output.event.LasersChanged = 0;
    me->_output.event.DoorOverride = 0;
    me->_output.event.VacuumTimerElapsed = 0;

    me->EmergencyStopped = 1;
    me->BottlePositions[0] = 0;
    me->BottlePositions[1] = 0;
    me->BottlePositions[2] = 0;
    me->BottlePositions[3] = 0;
    me->BottlesActive[0] = false;
    me->BottlesActive[1] = false;
    me->BottlesActive[2] = false;
    me->BottlesActive[3] = false;
    me->NextBottle = 0;
    me->InternalConveyorSpeed = 0;
}

/* ECC algorithms */
void IOManager_IOAlgorithm(IOManager* me)
{
#define NUM_BOTTLES 4

int i;

//reset all the things
me->EmergencyStop = 0;
me->CanisterPressure = 255;
me->FillContentsAvailable = 255;
me->DoorSiteLaser = 0;
me->InjectSiteLaser = 0;
me->RejectSiteLaser = 0;
me->RejectBinLaser = 0;
me->AcceptBinLaser = 0;


////printf("=====new tick\n");

//continue progress
if(me->ConveyorSpeed) {
		if(me->BottlesActive[1]) {
			me->BottlePositions[1] += me->InternalConveyorSpeed;
			//printf("IO: Canister %i moves to %i\n", i, me->BottlePositions[1]);
			
			if(me->BottlePositions[1] == 5) {
				//printf("IO: Canister %i at 5, triggering InjectSiteLaser\n", i);
				me->_output.event.LasersChanged = 1;
				me->InjectSiteLaser = 1;
			} else if(me->BottlePositions[1] == 10) {
				//printf("IO: Canister %i at 10, triggering RejectSiteLaser\n", i);
				me->_output.event.LasersChanged = 1;
				me->RejectSiteLaser = 1;
			} else if(me->BottlePositions[1] == 20) {
				//printf("IO: Canister %i at 20, falls off conveyor, triggering AcceptBinLaser\n", i);
				me->_output.event.LasersChanged = 1;
				me->AcceptBinLaser = 1;
				me->BottlesActive[1] = 0;
				me->BottlePositions[1] = 0;
			} 
			
			if(me->_input.event.GoRejectArm && (me->BottlePositions[1] == 10 || me->BottlePositions[1] == 11 || me->BottlePositions[1] == 12)) {
				//printf("IO: Go Reject Arm. Canister %i knocked from conveyor.\n", i);
				//progress = 0;
				me->_output.event.LasersChanged = 1;
				me->RejectBinLaser = 1;
				me->BottlesActive[1] = 0;
				me->BottlePositions[1] = 0;
			}
		}
	}

	if(me->ConveyorSpeed) {
		if(me->BottlesActive[2]) {
			me->BottlePositions[2] += me->InternalConveyorSpeed;
			//printf("IO: Canister %i moves to %i\n", i, me->BottlePositions[2]);
			
			if(me->BottlePositions[2] == 5) {
				//printf("IO: Canister %i at 5, triggering InjectSiteLaser\n", i);
				me->_output.event.LasersChanged = 1;
				me->InjectSiteLaser = 1;
			} else if(me->BottlePositions[2] == 10) {
				//printf("IO: Canister %i at 10, triggering RejectSiteLaser\n", i);
				me->_output.event.LasersChanged = 1;
				me->RejectSiteLaser = 1;
			} else if(me->BottlePositions[2] == 20) {
				//printf("IO: Canister %i at 20, falls off conveyor, triggering AcceptBinLaser\n", i);
				me->_output.event.LasersChanged = 1;
				me->AcceptBinLaser = 1;
				me->BottlesActive[2] = 0;
				me->BottlePositions[2] = 0;
			} 
			
			if(me->_input.event.GoRejectArm && (me->BottlePositions[2] == 10 || me->BottlePositions[2] == 11 || me->BottlePositions[2] == 12)) {
				//printf("IO: Go Reject Arm. Canister %i knocked from conveyor.\n", i);
				//progress = 0;
				me->_output.event.LasersChanged = 1;
				me->RejectBinLaser = 1;
				me->BottlesActive[2] = 0;
				me->BottlePositions[2] = 0;
			}
		}
	}

	if(me->ConveyorSpeed) {
		if(me->BottlesActive[3]) {
			me->BottlePositions[3] += me->InternalConveyorSpeed;
			//printf("IO: Canister %i moves to %i\n", i, me->BottlePositions[3]);
			
			if(me->BottlePositions[3] == 5) {
				//printf("IO: Canister %i at 5, triggering InjectSiteLaser\n", i);
				me->_output.event.LasersChanged = 1;
				me->InjectSiteLaser = 1;
			} else if(me->BottlePositions[3] == 10) {
				//printf("IO: Canister %i at 10, triggering RejectSiteLaser\n", i);
				me->_output.event.LasersChanged = 1;
				me->RejectSiteLaser = 1;
			} else if(me->BottlePositions[3] == 20) {
				//printf("IO: Canister %i at 20, falls off conveyor, triggering AcceptBinLaser\n", i);
				me->_output.event.LasersChanged = 1;
				me->AcceptBinLaser = 1;
				me->BottlesActive[3] = 0;
				me->BottlePositions[3] = 0;
			} 
			
			if(me->_input.event.GoRejectArm && (me->BottlePositions[3] == 10 || me->BottlePositions[3] == 11 || me->BottlePositions[3] == 12)) {
				//printf("IO: Go Reject Arm. Canister %i knocked from conveyor.\n", i);
				//progress = 0;
				me->_output.event.LasersChanged = 1;
				me->RejectBinLaser = 1;
				me->BottlesActive[3] = 0;
				me->BottlePositions[3] = 0;
			}
		}
	}

	if(me->ConveyorSpeed) {
		if(me->BottlesActive[0]) {
			me->BottlePositions[0] += me->InternalConveyorSpeed;
			//printf("IO: Canister %i moves to %i\n", i, me->BottlePositions[0]);
			
			if(me->BottlePositions[0] == 5) {
				//printf("IO: Canister %i at 5, triggering InjectSiteLaser\n", i);
				me->_output.event.LasersChanged = 1;
				me->InjectSiteLaser = 1;
			} else if(me->BottlePositions[0] == 10) {
				//printf("IO: Canister %i at 10, triggering RejectSiteLaser\n", i);
				me->_output.event.LasersChanged = 1;
				me->RejectSiteLaser = 1;
			} else if(me->BottlePositions[0] == 20) {
				//printf("IO: Canister %i at 20, falls off conveyor, triggering AcceptBinLaser\n", i);
				me->_output.event.LasersChanged = 1;
				me->AcceptBinLaser = 1;
				me->BottlesActive[0] = 0;
				me->BottlePositions[0] = 0;
			} 
			
			if(me->_input.event.GoRejectArm && (me->BottlePositions[0] == 10 || me->BottlePositions[0] == 11 || me->BottlePositions[0] == 12)) {
				//printf("IO: Go Reject Arm. Canister %i knocked from conveyor.\n", i);
				//progress = 0;
				me->_output.event.LasersChanged = 1;
				me->RejectBinLaser = 1;
				me->BottlesActive[0] = 0;
				me->BottlePositions[0] = 0;
			}
		}
	}

//if(canisterProgress == 25) {
// //printf("Progress at 25, halting\n");
// while(1);
//}

if(me->_input.event.InjectDone) {
 //printf("IO: Inject done\n");
}



if(me->EmergencyStopped == 1) {
 //printf("IO: Releasing emergency stop\n");
 me->_output.event.EmergencyStopChanged = 1;
 me->EmergencyStop = 0;
 me->EmergencyStopped++;
} else {
 
 if(me->_input.event.DoorReleaseCanister) {
  //printf("IO: Door released. Adding canister %i\n", me->NextBottle);

  me->_output.event.LasersChanged = 1;
  me->DoorSiteLaser = 1;
   
  me->BottlesActive[me->NextBottle] = 1;

  me->NextBottle++;
  me->NextBottle = me->NextBottle % 4;
  
 }
 if(me->_input.event.InjectorPositionChanged) {
  //printf("IO: Injector position changed. Setting move finished.\n");
  me->_output.event.InjectorArmFinishMovement = 1;
 }

 if(me->_input.event.ConveyorChanged) {
  me->InternalConveyorSpeed = me->ConveyorSpeed;
  //printf("IO: Setting conveyor movement to %i\n", me->InternalConveyorSpeed);
 }

 

 if(me->_input.event.InjectorControlsChanged) {
  //printf("IO: Injector controls changed. Now they are Vac: %1i Val: %1i Pmp: %1i\n", me->InjectorVacuumRun, me->InjectorContentsValveOpen, me->InjectorPressurePumpRun);
  if(me->InjectorVacuumRun) {
   //printf("IO: Due to vacuum, changing canister pressure to 5.\n");
   me->CanisterPressure = 5;
   me->_output.event.CanisterPressureChanged = 1;
  }
  if(me->InjectorContentsValveOpen) {
   //printf("IO: Contents valve now open. Pressure changes slightly, sucking in contents.\n");
   me->CanisterPressure = 20;
   me->_output.event.CanisterPressureChanged = 1;
  }
  if(me->InjectorPressurePumpRun) {
   //printf("IO: Due to pressure pump, changing canister pressure to 250.\n");
   me->CanisterPressure = 250;
   me->_output.event.CanisterPressureChanged = 1;
  }
 }
 
 if(me->_input.event.FillContentsChanged) {
  //printf("IO: Fill contents changed.\n");
 }

 if(me->_input.event.StartVacuumTimer) {
  //printf("IO: Start vacuum timer.\n");//Elapsing timer.\n");
  //me->_output.event.VacuumTimerElapsed = 1;
 }

 

 if(me->_input.event.CanisterCountChanged) {
  //printf("IO: Canister count changed. New value: %i\n", me->CanisterCount);
 }


}



}

/* Function block execution function */
void IOManagerrun(IOManager* me)
{
    int _PRET_BOUND_i = 0;
    me->_output.event.InjectorArmFinishMovement = 0;
    me->_output.event.EmergencyStopChanged = 0;
    me->_output.event.CanisterPressureChanged = 0;
    me->_output.event.FillContentsAvailableChanged = 0;
    me->_output.event.LasersChanged = 0;
    me->_output.event.DoorOverride = 0;
    me->_output.event.VacuumTimerElapsed = 0;


        if (me->_input.event.ConveyorChanged) {
            me->ConveyorSpeed = me->_ConveyorSpeed;
        }
        if (me->_input.event.InjectorPositionChanged) {
            me->InjectorPosition = me->_InjectorPosition;
        }
        if (me->_input.event.InjectorControlsChanged) {
            me->InjectorContentsValveOpen = me->_InjectorContentsValveOpen;
            me->InjectorVacuumRun = me->_InjectorVacuumRun;
            me->InjectorPressurePumpRun = me->_InjectorPressurePumpRun;
        }
        if (me->_input.event.FillContentsChanged) {
            me->FillContents = me->_FillContents;
        }
        if (me->_input.event.CanisterCountChanged) {
            me->CanisterCount = me->_CanisterCount;
        }
    
	#pragma loopbound min 1 max 2
    for (;;) {
        // State: Start
        if (!me->_entered) {
            IOManager_IOAlgorithm(me);
            me->_output.event.EmergencyStopChanged = 1;
            me->_entered = true;
            break;
        }
        else {
            me->_entered = false;
            continue;
            break;
        }
        break;
    }
    if (me->_output.event.EmergencyStopChanged) {
        me->_EmergencyStop = me->EmergencyStop;
    }
    if (me->_output.event.CanisterPressureChanged) {
        me->_CanisterPressure = me->CanisterPressure;
    }
    if (me->_output.event.FillContentsAvailableChanged) {
        me->_FillContentsAvailable = me->FillContentsAvailable;
    }
    if (me->_output.event.LasersChanged) {
        me->_DoorSiteLaser = me->DoorSiteLaser;
        me->_InjectSiteLaser = me->InjectSiteLaser;
        me->_RejectSiteLaser = me->RejectSiteLaser;
        me->_RejectBinLaser = me->RejectBinLaser;
        me->_AcceptBinLaser = me->AcceptBinLaser;
    }

    me->_input.event.DoorReleaseCanister = 0;
    me->_input.event.ConveyorChanged = 0;
    me->_input.event.InjectorPositionChanged = 0;
    me->_input.event.InjectorControlsChanged = 0;
    me->_input.event.FillContentsChanged = 0;
    me->_input.event.StartVacuumTimer = 0;
    me->_input.event.GoRejectArm = 0;
    me->_input.event.CanisterCountChanged = 0;
	me->_input.event.InjectDone = 0;
}

