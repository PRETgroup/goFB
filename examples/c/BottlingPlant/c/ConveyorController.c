// This file has been automatically generated by go-iec61499 and should not be edited by hand
// Converter written by Hammond Pearce and available at github.com/kiwih/go-iec61499

// This file represents the implementation of the Basic Function Block for ConveyorController
#include "ConveyorController.h"

enum ConveyorController_states { STATE_E_Stop, STATE_Running, STATE_Pause }

void ConveyorController_init(struct ConveyorController *me) {
	//if there are output events, reset them
	me->outputEvents.ConveyorChanged = 0;
	me->outputEvents.ConveyorStoppedForInject = 0;
	
	//if there are output vars, reset them
	me->outputVars.ConveyorSpeed = 0;
	
	//if there are internal vars, reset them
	me->internalVars.Variable1 = 0;
	
}

void ConveyorController_run(struct ConveyorController *me) {
	//current state storage
	static enum ConveyorController_states state = STATE_E_Stop;
	static BOOL trigger = false;

	//if there are output events, reset them
	me->outputEvents.ConveyorChanged = 0;
	me->outputEvents.ConveyorStoppedForInject = 0;
	

	//now, let's advance state
	switch(state) {
	case STATE_E_Stop :
		if(me->inputEvents.EmergencyStopChanged AND (!me->inputVars.EmergencyStop)) {
			state = STATE_Running;
			trigger = true;
		};
	case STATE_Running :
		if(me->inputEvents.LasersChanged AND (me->inputVars.InjectSiteLaser)) {
			state = STATE_Pause;
			trigger = true;
		};
	case STATE_Pause :
		if(me->inputEvents.InjectDone) {
			state = STATE_Running;
			trigger = true;
		} else if(me->inputEvents.EmergencyStopChanged AND (me->inputVars.EmergencyStop)) {
			state = STATE_E_Stop;
			trigger = true;
		};
	
	}

	//now, let's run any algorithms and emit any events that need to occur due to the trigger
	if(trigger == true) {

	}
}

//algorithms

void ConveyorController_ConveyorStart(struct ConveyorController *me) {
ConveyorSpeed <= x"01";
DONE <= '1';
}

void ConveyorController_ConveyorStop(struct ConveyorController *me) {
ConveyorSpeed <= x"00";
DONE <= '1';
}

void ConveyorController_ConveyorRunning(struct ConveyorController *me) {
DONE <= '1';
}

void ConveyorController_ConveyorEStop(struct ConveyorController *me) {
DONE <= '1';
}



